<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>AWS Ubuntu 18.04 Instance to Azure or VMWare Migration or Any Other Virtualization - anindyabiswas.io</title><meta name="description" content="Story So Far, The company I work for uses AWS as a primary cloud provider. The product that I worked on is a tool that made Mobile applications. Now when we started getting Corporate/Enterprise customers, They started to ask for On-Premises deployment on either a VMWare Environment, Nutanix Enterprise Cloud,&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://anindyabiswasio.github.io/aws-ubuntu-instance-to-azure-or-vmware-migration.html"><link rel="amphtml" href="https://anindyabiswasio.github.io/amp/aws-ubuntu-instance-to-azure-or-vmware-migration.html"><link rel="alternate" type="application/atom+xml" href="https://anindyabiswasio.github.io/feed.xml"><link rel="alternate" type="application/json" href="https://anindyabiswasio.github.io/feed.json"><meta property="og:title" content="AWS Ubuntu 18.04 Instance to Azure or VMWare Migration or Any Other Virtualization"><meta property="og:image" content="https://anindyabiswasio.github.io/media/posts/9/splash1.jpg"><meta property="og:site_name" content="anindyabiswas.io"><meta property="og:description" content="Story So Far, The company I work for uses AWS as a primary cloud provider. The product that I worked on is a tool that made Mobile applications. Now when we started getting Corporate/Enterprise customers, They started to ask for On-Premises deployment on either a VMWare Environment, Nutanix Enterprise Cloud,&hellip;"><meta property="og:url" content="https://anindyabiswasio.github.io/aws-ubuntu-instance-to-azure-or-vmware-migration.html"><meta property="og:type" content="article"><link rel="shortcut icon" href="https://anindyabiswasio.github.io/media/website/favicon-16x16.png" type="image/x-icon"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link href="https://fonts.googleapis.com/css?family=Cairo:400,700|Maitree:400,700&amp;subset=latin-ext&amp;display=swap" rel="stylesheet"><style>:root{--body-font:'Maitree',serif;--heading-font:'Cairo',sans-serif;--logo-font:'Cairo',sans-serif;--menu-font:'Cairo',sans-serif}</style><link rel="stylesheet" href="https://anindyabiswasio.github.io/assets/css/style.css?v=252fb1b5380b19ed63d9bab3d2c67758"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://anindyabiswasio.github.io/aws-ubuntu-instance-to-azure-or-vmware-migration.html"},"headline":"AWS Ubuntu 18.04 Instance to Azure or VMWare Migration or Any Other Virtualization","datePublished":"2020-07-03T15:23","dateModified":"2020-07-07T13:22","image":{"@type":"ImageObject","url":"https://anindyabiswasio.github.io/media/posts/9/splash1.jpg","height":4160,"width":6240},"description":"Story So Far, The company I work for uses AWS as a primary cloud provider. The product that I worked on is a tool that made Mobile applications. Now when we started getting Corporate/Enterprise customers, They started to ask for On-Premises deployment on either a VMWare Environment, Nutanix Enterprise Cloud,&hellip;","author":{"@type":"Person","name":"Anindya Biswas"},"publisher":{"@type":"Organization","name":"Anindya Biswas"}}</script></head><body><script>function myFunction() {
  var copyText = document.getElementById("myInput");
  copyText.select();
  copyText.setSelectionRange(0, 99999)
  document.execCommand("copy");
  alert("Copied the text: " + copyText.value);
}</script><div class="site-container"><header class="top" id="js-header"><a class="logo" href="https://anindyabiswasio.github.io/">anindyabiswas.io</a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://anindyabiswasio.github.io/" target="_self">Home</a></li><li><a href="https://anindyabiswasio.github.io/about-me.html" target="_self">About Me</a></li></ul></nav><div class="search"><div class="search__overlay js-search-overlay"><div class="search__overlay-inner"><form action="https://anindyabiswasio.github.io/search.html" class="search__form"><input class="search__input js-search-input" type="search" name="q" placeholder="search..." aria-label="search..." autofocus="autofocus"></form><button class="search__close js-search-close" aria-label="Close">Close</button></div></div><button class="search__btn js-search-btn" aria-label="Search"><svg role="presentation" focusable="false"><use xlink:href="https://anindyabiswasio.github.io/assets/svg/svg-map.svg#search"/></svg></button></div></header><main><article class="post"><div class="hero"><figure class="hero__image hero__image--overlay"><img src="https://anindyabiswasio.github.io/media/posts/9/splash1.jpg" srcset="https://anindyabiswasio.github.io/media/posts/9/responsive/splash1-xs.jpg 300w, https://anindyabiswasio.github.io/media/posts/9/responsive/splash1-sm.jpg 480w, https://anindyabiswasio.github.io/media/posts/9/responsive/splash1-md.jpg 768w, https://anindyabiswasio.github.io/media/posts/9/responsive/splash1-lg.jpg 1024w, https://anindyabiswasio.github.io/media/posts/9/responsive/splash1-xl.jpg 1360w, https://anindyabiswasio.github.io/media/posts/9/responsive/splash1-2xl.jpg 1600w" sizes="(max-width: 1600px) 100vw, 1600px" loading="eager" height="4160" width="6240" alt=""></figure><header class="hero__content"><div class="wrapper"><div class="post__meta"><time datetime="2020-07-03T15:23">July 3, 2020</time></div><h1>AWS Ubuntu 18.04 Instance to Azure or VMWare Migration or Any Other Virtualization</h1></div></header></div><div class="wrapper post__entry"><div class="post__toc"><h3>Table of Contents</h3><ul><li><a href="#mcetoc_1eca0ciqp2r">Story So Far</a></li><li><a href="#mcetoc_1eca17npv30">The Process</a><ul><li><a href="#mcetoc_1eca2a6sa35">Step 1: Enable Root Access of AWS Instance via SSH</a></li><li><a href="#mcetoc_1eca2dc8a48">Step 2: Stop All Services on AWS Instance</a></li><li><a href="#mcetoc_1eca2dc8a49">Step 3: Create Azure Virtual Machine or VMWare</a></li><li><a href="#mcetoc_1eca2dc8a4a">Step 4: Start the migration</a></li><li><a href="#mcetoc_1eca2dc8a4b">Step 5: Install Azure Kernel</a></li><li><a href="#mcetoc_1eca2dc8a4c">Step 6: Perform Cleanup</a></li><li><a href="#mcetoc_1eca2dc8a4d">Step 7: Azure Agent</a></li></ul></li><li><a href="#mcetoc_1eca0bf8f2p">References</a></li><li><a href="#mcetoc_1eca5jfib4p">Contact Me</a></li><li><a href="#mcetoc_1eca6qchr5c">Document History</a></li></ul></div><h4 id="mcetoc_1eca0ciqp2r">Story So Far, </h4><p><span data-preserver-spaces="true">The company I work for uses AWS as a primary cloud provider. The product that I worked on is a tool that made Mobile applications. Now when we started getting Corporate/Enterprise customers, They started to ask for On-Premises deployment on either a </span><strong><span data-preserver-spaces="true">VMWare</span></strong><span data-preserver-spaces="true"> Environment, </span><strong><span data-preserver-spaces="true">Nutanix</span></strong><span data-preserver-spaces="true"> Enterprise Cloud, or on their Azure Instances in their accounts. Some organizations used AWS so it was easy, we would just share the AMI for the AWS Images and be done with it. However, the challenge was when they wanted deployments of production on their cloud or On-premises solutions. </span></p><p><span data-preserver-spaces="true">After failing a few times I found a way to reliably moving around across any Virtualization System.</span></p><h4 id="mcetoc_1eca17npv30">The Process</h4><p><span data-preserver-spaces="true">The idea behind this is a simple one. We just copy all the files in the root (/) from a </span><strong><span data-preserver-spaces="true">Source</span></strong><span data-preserver-spaces="true"> instance to </span><strong><span data-preserver-spaces="true">Destination </span></strong><span data-preserver-spaces="true">Instance.</span></p><p><span data-preserver-spaces="true">Here are the steps I performed.</span></p><h5 id="mcetoc_1eca2a6sa35">Step 1: Enable Root Access of AWS Instance via SSH</h5><p><span data-preserver-spaces="true">On AWS </span><strong><span data-preserver-spaces="true">"root user"</span></strong><span data-preserver-spaces="true"> access is restricted via SSH and this is done on purpose for security reasons. However, we require root access as we will be copying system-level files.</span></p><p><span data-preserver-spaces="true">To do this we must do 3 things.</span></p><ul style="list-style-type: square;"><li><strong>Copy .ssh folder</strong> from Logged in User to /root folder, the purpose for this is to have the same key we use to login.</li></ul><table style="border-collapse: collapse; background-color: #000000; border-color: #3598db; border-style: outset; height: 10px;" width="699"><tbody><tr><th style="width: 700.8px;"><span style="color: #2dc26b;">sudo cp -R .ssh /root</span></th></tr></tbody></table><ul style="list-style-type: square;"><li>Edit <strong>/etc/ssh/sshd_config</strong></li></ul><table style="border-collapse: collapse; background-color: #000000; border-color: #3598db; border-style: outset; height: 10px;" width="699"><tbody><tr><th style="width: 700.8px;"><span style="color: #2dc26b;">sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config</span></th></tr></tbody></table><ul style="list-style-type: square;"><li>Restart <strong>SSH Service</strong></li></ul><table style="border-collapse: collapse; background-color: #000000; border-color: #3598db; border-style: outset; height: 10px;" width="699"><tbody><tr><th style="width: 700.8px;"><span style="color: #2dc26b;">sudo service ssh restart</span></th></tr></tbody></table><p>That should be it.</p><h5 id="mcetoc_1eca2dc8a48">Step 2: Stop All Services on AWS Instance</h5><p>The purpose of this step is to make sure no process keeps some files in a locked state which may fail step 4. Like sometimes MongoDB or PostgreSQL may lock files that prevent it from copying. So List all services and Stop all of them.</p><p class="align-center"><span style="color: #e03e2d;"><strong>"Do not stop ssh service"</strong></span></p><h5 id="mcetoc_1eca2dc8a49">Step 3: Create Azure Virtual Machine or VMWare</h5><p>Here we want to create a Virtual Machine on either Azure or VMware. For VMWare I created a VMWare Workstation Image with Ubuntu 18.04 update it and rebooted it. The core idea is the system should be as close to the AWS Instance as possible in terms of updates. Not that it matters much as next step will remove everything you just installed.</p><h5 id="mcetoc_1eca2dc8a4a">Step 4: Start the migration</h5><p>This process is for the actual migration of the user instance from AWS to Azure/VMWare. </p><p>First we Upload the instance Key that we use to login to AWS to Azure/VMWare.</p><p>Second we run this command to start the Syncing do not copy paste it, the explanation is below</p><table style="border-collapse: collapse; background-color: #000000; border-color: #3598db; border-style: outset; height: 121px; width: 695px;" width="1047"><tbody><tr><th style="width: 721.6px;"><p><span style="color: #2dc26b;"># sudo su</span></p><p><span style="color: #2dc26b;"># rsync -ahPHAXx --delete --exclude={/dev/*,/proc/*,/sys/*,/run/*,/mnt/*,/media/*,/lost+found,/boot,/etc/fstab,/swapfile} -e "ssh -i /home/ubuntu/instanceKey.pem" root@ec2-54-299-20-38.ap-southeast-1.compute.amazonaws.com:/ /</span></p></th></tr></tbody></table><p><strong>Command Explained <sup>[1]</sup></strong></p><p><code>--delete                delete extraneous files from dest dirs</code></p><p><strong>Purpose</strong>: We delete all files that don't belong to source AWS Instance FS.</p><p><code>--exclude=PATTERN       exclude files matching PATTERN</code></p><p><strong>Purpose</strong>: We delete all files except these files.</p><p><code>-e, --rsh=COMMAND           specify the remote shell to use</code></p><p><strong>Purpose</strong>: <span style="color: #000000;">We use the command for Remote Connection. In our case it is :</span></p><table style="border-collapse: collapse; width: 100%; height: 174px;" border="1"><tbody><tr style="height: 174px;"><td style="width: 100%; height: 174px;"><p>"ssh -i /home/ubuntu/instanceKey.pem" <a href="mailto:root@ec2-54-299-20-38.ap-southeast-1.compute.amazonaws.com:/">root@ec2-54-299-20-38.ap-southeast-1.compute.amazonaws.com:/</a></p><p>SSH Key: instanceKey.pem</p><p>Instance IP: ec2-54-299-20-38.ap-southeast-1.compute.amazonaws.com</p><p>The :/ at the end means start rsync from /</p></td></tr></tbody></table><h5 id="mcetoc_1eca2dc8a4b">Step 5: Install Azure/VMWare Kernel</h5><p>This step is actually very important if you want a bootable Virtual Machine. In the previous command your boot configuration is corrupt, as rsync has removed most of the configuration. To fix this we need to reinstall the kernel which will configure grub boot-loader.</p><p><strong>Azure Kernel</strong></p><table style="border-collapse: collapse; background-color: #000000; border-color: #3598db; border-style: outset; height: 121px;" width="1047"><tbody><tr><th style="width: 721.6px;"><p><span style="color: #2dc26b;"># sudo apt-get update</span></p><p><span style="color: #2dc26b;"># sudo apt-get install linux-modules-5.0.0-1036-azure linux-image-5.0.0-1036-azure linux-azure linux-image-azure linux-azure-headers-5.0.0-1036 linux-headers-5.0.0-1036-azure linux-headers-azure linux-azure-tools-5.0.0-1036 linux-tools-5.0.0-1036-azure linux-tools-azure linux-azure-cloud-tools-5.0.0-1036 linux-cloud-tools-5.0.0-1036-azure linux-cloud-tools-azure</span></p></th></tr></tbody></table><p><strong>For VMWare Install Generic Kernel</strong></p><table style="border-collapse: collapse; background-color: #000000; border-color: #3598db; border-style: outset; height: 10px;" width="699"><tbody><tr><th style="width: 700.8px;"><p><span style="color: #2dc26b;"># sudo apt-get update</span></p><p><span style="color: #2dc26b;"># </span><span style="color: #2dc26b; font-weight: var(--font-weight-semibold); font-family: var(--font-base); font-size: inherit;">sudo apt-get install --install-recommends linux-generic-hwe-18.04</span></p></th></tr></tbody></table><h5 id="mcetoc_1eca2dc8a4c">Step 6: Perform Cleanup</h5><p>AWS Systems Manager Agent (SSM Agent) is Amazon software that can be installed and configured on an EC2 instance.<sup>[2]</sup></p><table style="border-collapse: collapse; background-color: #000000; border-color: #3598db; border-style: outset; height: 40px;" width="694"><tbody><tr><th style="width: 700.8px;"><span style="color: #2dc26b;">sudo snap remove amazon-ssm-agent</span></th></tr></tbody></table><h5 id="mcetoc_1eca2dc8a4d">Step 7: Auto remove </h5><p>Here we will remove all AWS Kernels</p><table style="border-collapse: collapse; background-color: #000000; border-color: #3598db; border-style: outset; height: 40px;" width="694"><tbody><tr><th style="width: 700.8px;"><span style="color: #2dc26b;">sudo apt-get autoremove</span></th></tr></tbody></table><h5 id="mcetoc_1eca2dc8a4d">Step 8: Azure Agent</h5><p>The Microsoft Azure Linux Agent (waagent) manages Linux &amp; FreeBSD provisioning, and VM interaction with the Azure Fabric Controller.<sup>[3]</sup></p><table style="border-collapse: collapse; background-color: #000000; border-color: #3598db; border-style: outset; height: 40px;" width="694"><tbody><tr><th style="width: 700.8px;"><span style="color: #2dc26b;">sudo apt-get install walinuxagent</span></th></tr></tbody></table><h5>References</h5><p>[1] <a href="https://www.man7.org/linux/man-pages/man1/rsync.1.html">https://www.man7.org/linux/man-pages/man1/rsync.1.html</a></p><p>[2] <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-agent.html">https://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-agent.html</a></p><p>[3] <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/agent-linux">https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/agent-linux</a></p><h4 id="mcetoc_1eca5jfib4p">Contact Me</h4><p>If you find errors in this Article or want to contribute to make this article better or just want to provide feedback, please contact me. I am new to blogging so excuse my noob mistakes.</p><h4 id="mcetoc_1eca6qchr5c">Document History</h4><table style="border-collapse: collapse; width: 100%;" border="1"><tbody><tr><td style="width: 11.6808%;"><strong>Version</strong></td><td style="width: 43.4473%;"><strong>Changes</strong></td><td style="width: 44.8718%;"><strong>Remark</strong></td></tr><tr><td style="width: 11.6808%;">0.1</td><td style="width: 43.4473%;">Just started this document. May change in time.</td><td style="width: 44.8718%;">Just started. Work in progress. Next Version Elaborate Step 4 and 7. Also Correct Grammar.</td></tr><tr><td style="width: 11.6808%;">0.2</td><td style="width: 43.4473%;">Made a few more additions</td><td style="width: 44.8718%;"> </td></tr></tbody></table><p> </p></div><footer class="wrapper post__footer"><p class="post__last-updated">This article was updated on July 7, 2020</p><ul class="post__tag"><li><a href="https://anindyabiswasio.github.io/cloud-computing/">Cloud Computing</a></li><li><a href="https://anindyabiswasio.github.io/linux/">Linux</a></li></ul><div class="post__share"><a href="http://www.linkedin.com/shareArticle?url=https%3A%2F%2Fanindyabiswasio.github.io%2Faws-ubuntu-instance-to-azure-or-vmware-migration.html&amp;title=AWS%20Ubuntu%2018.04%20Instance%20to%20Azure%20or%20VMWare%20Migration%20or%20Any%20Other%20Virtualization" class="js-share linkedin" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://anindyabiswasio.github.io/assets/svg/svg-map.svg#linkedin"/></svg> <span>LinkedIn</span></a></div><div class="post__bio bio"><img class="bio__avatar" src="https://anindyabiswasio.github.io/media/website/anindya.png" loading="lazy" alt="Anindya Biswas"><div class="bio__info"><h3 class="bio__name"><a href="https://anindyabiswasio.github.io/authors/anindya-biswas/" class="invert" rel="author">Anindya Biswas</a></h3><p>I am currently interested in Gaming, Coding, Linux, Cloud Computing, Raspberry Pi, System Designs and motorcycles. With the lockdown, cooking is a new interest. You could say a Swiss army knife of unrelated interests.</p></div></div></footer></article><nav class="post__nav"><div class="post__nav-inner"><div class="post__nav-prev"><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://anindyabiswasio.github.io/assets/svg/svg-map.svg#arrow-prev"/></svg> <a href="https://anindyabiswasio.github.io/why-start-a-blog-now.html" class="invert post__nav-link" rel="prev"><span>Previous</span> Hello World</a></div><div class="post__nav-next"><a href="https://anindyabiswasio.github.io/a-load-balanced-solution-and-horizontal-scaling.html" class="invert post__nav-link" rel="next"><span>Next</span> A Load Balanced solution and Scaling-Out Design </a><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://anindyabiswasio.github.io/assets/svg/svg-map.svg#arrow-next"/></svg></div></div></nav></main><footer class="footer"><div class="footer__social"><a href="https://www.linkedin.com/in/anindya-kumar-biswas/" aria-label="LinkedIn"><svg><use xlink:href="https://anindyabiswasio.github.io/assets/svg/svg-map.svg#linkedin"/></svg></a></div><div class="footer__copyright"><p>Anindya Biswas</p></div><button class="footer__bttop js-footer__bttop" aria-label="Back to top"><svg><title>Back to top</title><use xlink:href="https://anindyabiswasio.github.io/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.top',
   };</script><script defer="defer" src="https://anindyabiswasio.github.io/assets/js/scripts.min.js?v=f4c4d35432d0e17d212f2fae4e0f8247"></script><script>var images = document.querySelectorAll('img[loading]');

        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><div class="cookie-popup js-cookie-popup cookie-popup--uses-badge"><h2>This website uses cookies</h2><p>This is my personal website. I really don't create any cookies unless this tool publii which is used to create this site creates cookies. <a href="#not-specified"></a></p><form><p class="cookie-popup__save-wrapper"><button type="submit" class="cookie-popup__save">I See Your Point</button></p></form><span class="cookie-popup-label">No Cookie Policy</span></div><script>(function() {
                function addScript (src, inline) {
                    var newScript = document.createElement('script');

                    if (src) {
                        newScript.setAttribute('src', src);
                    }

                    if (inline) {
                        newScript.text = inline;
                    }

                    document.body.appendChild(newScript);
                }

                var popup = document.querySelector('.js-cookie-popup');
                var checkboxes = popup.querySelectorAll('input[type="checkbox"]');
                var save = popup.querySelector('button');
                var currentConfig = localStorage.getItem('publii-gdpr-allowed-cookies');
                var blockedScripts = document.querySelectorAll('script[type^="gdpr-blocker/"]');
                

                popup.addEventListener('click', function() {
                    if (!popup.classList.contains('cookie-popup--is-sticky')) {
                        popup.classList.add('cookie-popup--is-sticky');
                    }
                });

                save.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    popup.classList.remove('cookie-popup--is-sticky');
                    var allowedGroups = [];

                    for (var i = 0; i < checkboxes.length; i++) {
                        if (checkboxes[i].checked) {
                            var groupName = checkboxes[i].getAttribute('name').replace('gdpr-', '');
                            var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + groupName + '"]');

                            for (var j = 0; j < scripts.length; j++) {
                                addScript(scripts[j].src, scripts[j].text);
                            }

                            allowedGroups.push(groupName);
                        }
                    }

                    localStorage.setItem('publii-gdpr-allowed-cookies', allowedGroups.join(','));
                    popup.classList.remove('cookie-popup--is-sticky');

                    setTimeout(function () {
                        if (currentConfig !== null) {
                            window.location.reload();
                        }
                    }, 250);
                });

                if (currentConfig === null) {
                    popup.classList.add('cookie-popup--is-sticky');
                } else {
                    if (currentConfig !== '') {
                        var allowedGroups = currentConfig.split(',');

                        for (var i = 0; i < allowedGroups.length; i++) {
                            var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroups[i] + '"]');
                            var checkbox = popup.querySelector('input[type="checkbox"][name="gdpr-' + allowedGroups[i] + '"]');

                            if (checkbox) {
                                checkbox.checked = true;
                            }

                            for (var j = 0; j < scripts.length; j++) {
                                addScript(scripts[j].src, scripts[j].text);
                            }
                        }
                    }
                }
            })();</script></body></html>