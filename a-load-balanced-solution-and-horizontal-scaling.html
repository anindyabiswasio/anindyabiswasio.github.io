<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>A Load Balanced solution and Horizontal Scaling - anindyabiswas.io</title><meta name="description" content="Story So Far We had a client for who we made an end-user mobile application that we had build and build the backend systems with usual connectors to connect to their backend APIs which then connected to SAP backends. Seems to be a usual gig where&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="http://anindyabiswas.io/a-load-balanced-solution-and-horizontal-scaling.html"><link rel="amphtml" href="http://anindyabiswas.io/amp/a-load-balanced-solution-and-horizontal-scaling.html"><link rel="alternate" type="application/atom+xml" href="http://anindyabiswas.io/feed.xml"><link rel="alternate" type="application/json" href="http://anindyabiswas.io/feed.json"><meta property="og:title" content="A Load Balanced solution and Horizontal Scaling"><meta property="og:image" content="http://anindyabiswas.io/media/posts/10/splash1.jpg"><meta property="og:site_name" content="anindyabiswas.io"><meta property="og:description" content="Story So Far We had a client for who we made an end-user mobile application that we had build and build the backend systems with usual connectors to connect to their backend APIs which then connected to SAP backends. Seems to be a usual gig where&hellip;"><meta property="og:url" content="http://anindyabiswas.io/a-load-balanced-solution-and-horizontal-scaling.html"><meta property="og:type" content="article"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link href="https://fonts.googleapis.com/css?family=Cairo:400,700|Maitree:400,700&amp;subset=latin-ext&amp;display=swap" rel="stylesheet"><style>:root{--body-font:'Maitree',serif;--heading-font:'Cairo',sans-serif;--logo-font:'Cairo',sans-serif;--menu-font:'Cairo',sans-serif}</style><link rel="stylesheet" href="http://anindyabiswas.io/assets/css/style.css?v=c1bb9176630f4d2e8815ac4648df263b"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"http://anindyabiswas.io/a-load-balanced-solution-and-horizontal-scaling.html"},"headline":"A Load Balanced solution and Horizontal Scaling","datePublished":"2020-07-04T17:42","dateModified":"2020-07-05T14:14","image":{"@type":"ImageObject","url":"http://anindyabiswas.io/media/posts/10/splash1.jpg","height":4160,"width":6240},"description":"Story So Far We had a client for who we made an end-user mobile application that we had build and build the backend systems with usual connectors to connect to their backend APIs which then connected to SAP backends. Seems to be a usual gig where&hellip;","author":{"@type":"Person","name":"Anindya Biswas"},"publisher":{"@type":"Organization","name":"Anindya Biswas"}}</script></head><body><script>function myFunction() {
  var copyText = document.getElementById("myInput");
  copyText.select();
  copyText.setSelectionRange(0, 99999)
  document.execCommand("copy");
  alert("Copied the text: " + copyText.value);
}</script><div class="site-container"><header class="top" id="js-header"><a class="logo" href="http://anindyabiswas.io/">anindyabiswas.io</a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="http://anindyabiswas.io/" target="_self">Home</a></li><li><a href="http://anindyabiswas.io/about-me.html" target="_self">About Me</a></li></ul></nav></header><main><article class="post"><div class="hero"><figure class="hero__image hero__image--overlay"><img src="http://anindyabiswas.io/media/posts/10/splash1.jpg" srcset="http://anindyabiswas.io/media/posts/10/responsive/splash1-xs.jpg 300w, http://anindyabiswas.io/media/posts/10/responsive/splash1-sm.jpg 480w, http://anindyabiswas.io/media/posts/10/responsive/splash1-md.jpg 768w, http://anindyabiswas.io/media/posts/10/responsive/splash1-lg.jpg 1024w, http://anindyabiswas.io/media/posts/10/responsive/splash1-xl.jpg 1360w, http://anindyabiswas.io/media/posts/10/responsive/splash1-2xl.jpg 1600w" sizes="(max-width: 1600px) 100vw, 1600px" loading="eager" height="4160" width="6240" alt=""></figure><header class="hero__content"><div class="wrapper"><div class="post__meta"><time datetime="2020-07-04T17:42">July 4, 2020</time></div><h1>A Load Balanced solution and Horizontal Scaling</h1></div></header></div><div class="wrapper post__entry"><h4><strong><span data-preserver-spaces="true">Story So Far </span></strong></h4><p><span data-preserver-spaces="true">We had a client for who we made an end-user mobile application that we had build and build the backend systems with usual connectors to connect to their backend APIs which then connected to SAP backends.</span></p><p><span data-preserver-spaces="true">Seems to be a usual gig where the mobile application would first talk to our server which had it's own MongoDB and PostgresDB and have some bridging APIs to connect to Client APIs. When the field testing started, however, something interesting happened. Suddenly we saw a spike in the server loads on our AWS T1.small servers were let's say from a lack of a better word went "</span><strong><em><span data-preserver-spaces="true">Belly up</span></em></strong><span data-preserver-spaces="true">". As it turns out, their marketing team had announced the application to 30k users, and it was a disaster. We went from T1.Small Instances to T1.XXLarge Instances and boy it was complete mayhem. Long story condensed we failed, Scaling up does not help. They did have the application running for a while and then they got rid of it. Total humiliation and somehow I felt responsible for this failure.</span></p><figure class="post__image post__image--center"><img loading="lazy" src="http://anindyabiswas.io/media/posts/10/HClientArchitecture.png" sizes="(max-width: 48em) 100vw, 768px" srcset="http://anindyabiswas.io/media/posts/10/responsive/HClientArchitecture-xs.png 300w, http://anindyabiswas.io/media/posts/10/responsive/HClientArchitecture-sm.png 480w, http://anindyabiswas.io/media/posts/10/responsive/HClientArchitecture-md.png 768w, http://anindyabiswas.io/media/posts/10/responsive/HClientArchitecture-lg.png 1024w, http://anindyabiswas.io/media/posts/10/responsive/HClientArchitecture-xl.png 1360w, http://anindyabiswas.io/media/posts/10/responsive/HClientArchitecture-2xl.png 1600w" alt=""><figcaption>The recipe for disaster</figcaption></figure><blockquote><p><span data-preserver-spaces="true">But what is the point of failure if I don't learn from it. I said that to myself and started learning about infrastructure and scaling etc.</span></p></blockquote><p><span data-preserver-spaces="true">And here is what we learned</span></p><ol><li><span data-preserver-spaces="true">Our Servers behaved fine as long as the requests dealt with only PostgreSQL and MongoDB, however by that time T1 generation AWS instances were old.</span></li><li><span data-preserver-spaces="true">We had some problems internally where one service would call another service internally, there was a bottleneck there. I will write a separate blog on how we went around diagnosing the problem.</span></li><li><span data-preserver-spaces="true">Our biggest bottleneck was when we were calling API that the client had given us. Under load, the response time went up anywhere from 500ms to 15000ms. Which meant once a user submitted a request, wait indicator would keep spinning on the device they would lose hope and give up. Even when their transaction was complete. It was all synchronous.</span></li><li><span data-preserver-spaces="true">And I figured we didn't know enough and as Engineers, that's a feeling of failure.</span></li></ol><h4><strong><span data-preserver-spaces="true">Time for a Shift in Though</span></strong></h4><p><span data-preserver-spaces="true">Once we identified what caused all the failure specific first task in hand was to find and correct everything from the ground up. The first challenge was Upgrading User Instances from T1 generation to T2. The only issue is T1 generation instances were paravirtual (PV) while T2 was Hardware Virtual Machine(HVM). So I embarked on a 1-month journey to upgrade the VMs, it was not just upgrading the OS from Ubuntu 10.04 to 18.04 but also a lot of legacies had to be upgraded, Java Version, Ruby Gem files etc. It's not as easy as it seems as I had to rewrite a lot of java code to support the latest PostgreSQL(JDBC) and Mongo drivers.</span></p><p><span data-preserver-spaces="true">Next stage was to have a clear separation of services. We had two servers running Glassfish which ran 2 different sets services. And a ruby server that did it's own things. We were planning to move towards microservices in the future, so we decided to break down the jumbled mess of services into individual services that would run in Glassfish for the time being, till we had enough resources and time to convert and run them on docker containers. Ultimately moving all our services running on user instances servers and move them to work on Kubernetes clusters.  </span></p><p><span data-preserver-spaces="true">We planned a RabbitMQ plugins for any future need to connect to unreliable services. So problem 3 above could be sorted more efficiently and Asynchronously.</span></p><h4><span data-preserver-spaces="true">An <span style="font-size: 21.8684px;">Optimized</span> and improved system</span></h4><p><span data-preserver-spaces="true">We got another client last year the same scale as before this app was again an End User application Expected load of 10k users to begin with, till they can roll-out countrywide when they expect around 50k+ users for both Mobile and Web Application. Their prerequisite was they want to run it in Azure in the data center of the country of operation. And maybe in the future move all systems in-house or a VMWare or something called Nutanix Enterprise Cloud. </span></p><p><span data-preserver-spaces="true">Also, they wanted to migrate their MongoDB to PostgresqlDB, as manpower for the later is easier to find. </span></p><p><span data-preserver-spaces="true">With the prerequisites set we designed the following simplistically put.</span></p><figure class="post__image post__image--center"><img loading="lazy" src="http://anindyabiswas.io/media/posts/10/TClientArchitecture.png" sizes="(max-width: 48em) 100vw, 768px" srcset="http://anindyabiswas.io/media/posts/10/responsive/TClientArchitecture-xs.png 300w, http://anindyabiswas.io/media/posts/10/responsive/TClientArchitecture-sm.png 480w, http://anindyabiswas.io/media/posts/10/responsive/TClientArchitecture-md.png 768w, http://anindyabiswas.io/media/posts/10/responsive/TClientArchitecture-lg.png 1024w, http://anindyabiswas.io/media/posts/10/responsive/TClientArchitecture-xl.png 1360w, http://anindyabiswas.io/media/posts/10/responsive/TClientArchitecture-2xl.png 1600w" alt="Client Infra design Plan Overview"><figcaption>Clients Server Architecture Design Simplified</figcaption></figure><div>Instead of loading and clogging one Instance we have 2, to begin with, and scale up to 5 instances. Load balancer rules were set on trying to connect on port 443(https). In the future, if the load continues to grow we may just horizontally scale the infrastructure.</div><div> </div><div>Support Server for the moment is tasked with running Cron services (Maintainance Scripts, DB Compact, Backup to Cloud Storage and so on) and Some micro services for exposing out DB to Client's Existing services. Please note we didn't talk about security implementation for this design as it is a topic of another blog.</div><div> </div><blockquote><div>Keep It Simple Stupid</div></blockquote><div> </div><div>However so far, no major issues with the existing system. I think we managed to get things in order with this design. However, the idea is to move away from these traditional designs and make something better. Use containers and container orchestration and all that jazz. I definitely want to move in that direction in the future once I know the pitfalls and benefits for that. But I am a firm believer of the "KISS" philosophy and the idea of micro services seems to be a step in that direction.</div></div><footer class="wrapper post__footer"><p class="post__last-updated">This article was updated on July 5, 2020</p><ul class="post__tag"><li><a href="http://anindyabiswas.io/cloud-computing/">Cloud Computing</a></li><li><a href="http://anindyabiswas.io/design/">Design</a></li></ul><div class="post__share"><a href="http://www.linkedin.com/shareArticle?url=http%3A%2F%2Fanindyabiswas.io%2Fa-load-balanced-solution-and-horizontal-scaling.html&amp;title=A%20Load%20Balanced%20solution%20and%20Horizontal%20Scaling" class="js-share linkedin" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="http://anindyabiswas.io/assets/svg/svg-map.svg#linkedin"/></svg> <span>LinkedIn</span></a></div><div class="post__bio bio"><img class="bio__avatar" src="http://anindyabiswas.io/media/website/anindya.png" loading="lazy" alt="Anindya Biswas"><div class="bio__info"><h3 class="bio__name"><a href="http://anindyabiswas.io/authors/anindya-biswas/" class="invert" rel="author">Anindya Biswas</a></h3><p>I am currently interested in Gaming, Coding, Linux, Cloud Computing, Raspberry Pi, System Designs and motorcycles. With the lockdown, cooking is a new interest. You could say a Swiss army knife of unrelated interests.</p></div></div></footer></article><nav class="post__nav"><div class="post__nav-inner"><div class="post__nav-prev"><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="http://anindyabiswas.io/assets/svg/svg-map.svg#arrow-prev"/></svg> <a href="http://anindyabiswas.io/aws-ubuntu-instance-to-azure-or-vmware-migration.html" class="invert post__nav-link" rel="prev"><span>Previous</span> AWS Ubuntu 18.04 Instance to Azure or VMWare Migration or Any Other Virtualization</a></div></div></nav></main><footer class="footer"><div class="footer__social"><a href="https://www.linkedin.com/in/anindya-kumar-biswas/" aria-label="LinkedIn"><svg><use xlink:href="http://anindyabiswas.io/assets/svg/svg-map.svg#linkedin"/></svg></a></div><div class="footer__copyright"><p>Anindya Biswas</p></div><button class="footer__bttop js-footer__bttop" aria-label="Back to top"><svg><title>Back to top</title><use xlink:href="http://anindyabiswas.io/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.top',
   };</script><script defer="defer" src="http://anindyabiswas.io/assets/js/scripts.min.js?v=f4c4d35432d0e17d212f2fae4e0f8247"></script><script>var images = document.querySelectorAll('img[loading]');

        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><div class="cookie-popup js-cookie-popup cookie-popup--uses-badge"><h2>This website uses cookies</h2><p>This is my personal website. I really don't create any cookies unless this tool publii which is used to create this site creates cookies. <a href="#not-specified"></a></p><form><p class="cookie-popup__save-wrapper"><button type="submit" class="cookie-popup__save">I See Your Point</button></p></form><span class="cookie-popup-label">No Cookie Policy</span></div><script>(function() {
                function addScript (src, inline) {
                    var newScript = document.createElement('script');

                    if (src) {
                        newScript.setAttribute('src', src);
                    }

                    if (inline) {
                        newScript.text = inline;
                    }

                    document.body.appendChild(newScript);
                }

                var popup = document.querySelector('.js-cookie-popup');
                var checkboxes = popup.querySelectorAll('input[type="checkbox"]');
                var save = popup.querySelector('button');
                var currentConfig = localStorage.getItem('publii-gdpr-allowed-cookies');
                var blockedScripts = document.querySelectorAll('script[type^="gdpr-blocker/"]');
                

                popup.addEventListener('click', function() {
                    if (!popup.classList.contains('cookie-popup--is-sticky')) {
                        popup.classList.add('cookie-popup--is-sticky');
                    }
                });

                save.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    popup.classList.remove('cookie-popup--is-sticky');
                    var allowedGroups = [];

                    for (var i = 0; i < checkboxes.length; i++) {
                        if (checkboxes[i].checked) {
                            var groupName = checkboxes[i].getAttribute('name').replace('gdpr-', '');
                            var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + groupName + '"]');

                            for (var j = 0; j < scripts.length; j++) {
                                addScript(scripts[j].src, scripts[j].text);
                            }

                            allowedGroups.push(groupName);
                        }
                    }

                    localStorage.setItem('publii-gdpr-allowed-cookies', allowedGroups.join(','));
                    popup.classList.remove('cookie-popup--is-sticky');

                    setTimeout(function () {
                        if (currentConfig !== null) {
                            window.location.reload();
                        }
                    }, 250);
                });

                if (currentConfig === null) {
                    popup.classList.add('cookie-popup--is-sticky');
                } else {
                    if (currentConfig !== '') {
                        var allowedGroups = currentConfig.split(',');

                        for (var i = 0; i < allowedGroups.length; i++) {
                            var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroups[i] + '"]');
                            var checkbox = popup.querySelector('input[type="checkbox"][name="gdpr-' + allowedGroups[i] + '"]');

                            if (checkbox) {
                                checkbox.checked = true;
                            }

                            for (var j = 0; j < scripts.length; j++) {
                                addScript(scripts[j].src, scripts[j].text);
                            }
                        }
                    }
                }
            })();</script></body></html>